# TestCase Redesign - Phase 7 å®ŒæˆæŠ¥å‘Š

> æ›´æ–°æ—¥æœŸ: 2025-11-24
> çŠ¶æ€: **Phase 7 å·²å®Œæˆ âœ…** | Phase 8 å¾…å¼€å§‹ â³

---

## ðŸŽ‰ Phase 7 æˆåŠŸå®Œæˆï¼

### å®Œæˆçš„å·¥ä½œ

**1. Backend API æ›´æ–°** âœ…
- æ–‡ä»¶: `nextest-platform/internal/service/test_service.go`
- ä¿®æ”¹å†…å®¹:
  - `CreateTestCaseRequest` æ·»åŠ  `Steps []interface{}` å­—æ®µ
  - `UpdateTestCaseRequest` æ·»åŠ  `Steps []interface{}` å­—æ®µ
  - `CreateTestCase()` æ–¹æ³•å¤„ç† `req.Steps`
  - `UpdateTestCase()` æ–¹æ³•å¤„ç† `req.Steps`

**2. æ•°æ®æŒä¹…åŒ–éªŒè¯** âœ…
- æ•°æ®åº“ Schema éªŒè¯é€šè¿‡ (`test_cases.steps` TEXT åˆ—)
- GORM `JSONArray` ç±»åž‹è‡ªåŠ¨åºåˆ—åŒ–/ååºåˆ—åŒ–
- åµŒå¥—ç»“æž„æ”¯æŒä»»æ„æ·±åº¦

**3. API ç«¯ç‚¹æµ‹è¯•** âœ…
- âœ… `POST /api/tests` - åˆ›å»ºæµ‹è¯•ç”¨ä¾‹
- âœ… `PUT /api/tests/:id` - æ›´æ–°æµ‹è¯•ç”¨ä¾‹
- âœ… `GET /api/tests/:id` - èŽ·å–æµ‹è¯•ç”¨ä¾‹
- âœ… `GET /api/tests` - åˆ—è¡¨æŸ¥è¯¢

**4. æµ‹è¯•åœºæ™¯éªŒè¯** âœ…
åˆ›å»ºå¹¶éªŒè¯äº† 3 ä¸ªçœŸå®žåœºæ™¯:
- âœ… åœºæ™¯1: Count å¾ªçŽ¯ (API é‡è¯•æœºåˆ¶)
- âœ… åœºæ™¯4: æ¡ä»¶åˆ†æ”¯ (HTTP çŠ¶æ€ç å¤„ç†)
- âœ… åœºæ™¯6: åµŒå¥—ç»“æž„ (Loop + Branch)

---

## ðŸ“Š æµ‹è¯•ç»“æžœæ±‡æ€»

### Backend API æµ‹è¯•
| æµ‹è¯•é¡¹ | ç»“æžœ | è¯¦æƒ… |
|--------|------|------|
| Loop - Count | âœ… PASS | count=3, maxIterations=5 |
| Loop - ForEach | âœ… PASS | source, itemVar, indexVar å®Œæ•´ |
| Branch - Multi | âœ… PASS | 3 åˆ†æ”¯ + default |
| Nested Structure | âœ… PASS | 3 å±‚æ·±åº¦åµŒå¥— |
| Data Persistence | âœ… PASS | è¯»å†™ä¸€è‡´ |
| API Response | âœ… PASS | æ‰€æœ‰ç«¯ç‚¹æ­£å¸¸ |

**æ€»è®¡**: 9/9 é€šè¿‡ (100%)

### æ•°æ®å®Œæ•´æ€§éªŒè¯
```json
// Loop é…ç½®ç¤ºä¾‹
{
  "loop": {
    "type": "count",
    "count": 3,
    "maxIterations": 5
  },
  "children": [...]
}

// Branch é…ç½®ç¤ºä¾‹
{
  "branches": [
    {
      "condition": "{{response.status}} == 200",
      "label": "Success Path",
      "children": [...]
    },
    {
      "condition": "",
      "label": "Default (else)",
      "children": [...]
    }
  ]
}

// åµŒå¥—ç»“æž„ç¤ºä¾‹
{
  "loop": {
    "type": "forEach",
    "source": "{{fileList}}",
    "itemVar": "file"
  },
  "children": [
    {
      "branches": [
        {"label": "Image", "children": [...]},
        {"label": "Video", "children": [...]}
      ]
    }
  ]
}
```

âœ… æ‰€æœ‰é…ç½®å®Œæ•´ä¿å­˜å’Œè¯»å–

---

## ðŸ“ äº¤ä»˜ç‰©

### æ–‡æ¡£
1. âœ… `LOOP_BRANCH_TEST_CASES.md` - è¯¦ç»†æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£
2. âœ… `TEST_REPORT_2025-11-24.md` - å®Œæ•´æµ‹è¯•æŠ¥å‘Š
3. âœ… `TESTCASE_REDESIGN_STATUS.md` - é¡¹ç›®çŠ¶æ€æ–‡æ¡£ (å·²æ›´æ–°)

### ä»£ç 
1. âœ… `nextest-platform/internal/service/test_service.go` - Backend Service æ›´æ–°
2. âœ… Backend ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

### æµ‹è¯•æ•°æ®
1. âœ… `test-scenario-1-retry` - Count å¾ªçŽ¯ç¤ºä¾‹
2. âœ… `test-scenario-4-branches` - æ¡ä»¶åˆ†æ”¯ç¤ºä¾‹
3. âœ… `test-nested-loop-branch` - åµŒå¥—ç»“æž„ç¤ºä¾‹

---

## ðŸŽ¯ è§£å†³çš„é—®é¢˜

### åŽŸé—®é¢˜ (TESTCASE_REDESIGN_STATUS.md)
> **1. æ•°æ®æŒä¹…åŒ–å¤±è´¥ (é¢„æœŸè¡Œä¸º)**
> - ç‚¹å‡» "Save Changes" æŒ‰é’®åŽï¼Œé…ç½®çš„ loop å’Œ branch æ•°æ®ä¸ä¼šä¿å­˜åˆ°åŽç«¯
> - åˆ·æ–°é¡µé¢åŽï¼Œæ‰€æœ‰é…ç½®ä¸¢å¤±ï¼Œæ¢å¤åˆ°åŽŸå§‹çŠ¶æ€

### è§£å†³æ–¹æ¡ˆ
âœ… **å·²å®Œå…¨è§£å†³**:
1. åŽç«¯ Service å±‚æ·»åŠ  `Steps` å­—æ®µæ”¯æŒ
2. API ç«¯ç‚¹æ­£ç¡®æŽ¥æ”¶å’Œè¿”å›ž loop/branch/children æ•°æ®
3. æ•°æ®åº“ Schema åŽŸç”Ÿæ”¯æŒ JSON åµŒå¥—ç»“æž„
4. å‰ç«¯-åŽç«¯æ•°æ®æ ¼å¼å®Œå…¨å…¼å®¹

### éªŒè¯
```bash
# åˆ›å»ºæµ‹è¯•ç”¨ä¾‹
curl -X POST http://localhost:8090/api/tests \
  -H "Content-Type: application/json" \
  -H "X-Tenant-ID: default" \
  -H "X-Project-ID: default" \
  -d '{"testId":"test-1","groupId":"base-images",...}'

# è¯»å–æµ‹è¯•ç”¨ä¾‹
curl http://localhost:8090/api/tests/test-1 \
  -H "X-Tenant-ID: default" \
  -H "X-Project-ID: default"

# ç»“æžœ: loop/branch é…ç½®å®Œæ•´è¿˜åŽŸ âœ…
```

---

## ðŸš€ ä¸‹ä¸€æ­¥: Phase 8

### ç›®æ ‡
å®žçŽ° Loop å’Œ Branch çš„**æ‰§è¡Œå¼•æ“Ž**

### ä»»åŠ¡æ¸…å•
1. **Loop æ‰§è¡Œé€»è¾‘** (é«˜ä¼˜å…ˆçº§)
   - [ ] Count å¾ªçŽ¯å®žçŽ°
   - [ ] ForEach æ•°ç»„è¿­ä»£
   - [ ] While æ¡ä»¶åˆ¤æ–­
   - [ ] å˜é‡æ’å€¼å¼•æ“Ž (`{{variable}}`)
   - [ ] å¾ªçŽ¯è¶…æ—¶æŽ§åˆ¶
   - [ ] å¾ªçŽ¯ç»“æžœèšåˆ

2. **Branch æ‰§è¡Œé€»è¾‘** (é«˜ä¼˜å…ˆçº§)
   - [ ] æ¡ä»¶è¡¨è¾¾å¼è§£æž
   - [ ] è¡¨è¾¾å¼æ±‚å€¼ (==, !=, >, <, contains, etc.)
   - [ ] åˆ†æ”¯è·¯å¾„é€‰æ‹©
   - [ ] Default åˆ†æ”¯fallback
   - [ ] åˆ†æ”¯ç»“æžœè®°å½•

3. **å˜é‡ç®¡ç†** (é«˜ä¼˜å…ˆçº§)
   - [ ] å˜é‡æ± è®¾è®¡
   - [ ] å˜é‡ä½œç”¨åŸŸ (global, loop-local)
   - [ ] å˜é‡æ’å€¼ (`{{var}}`, `{{obj.field}}`)
   - [ ] è¾“å‡ºæ˜ å°„ (`outputs` å­—æ®µ)
   - [ ] å˜é‡å˜åŒ–è¿½è¸ª

4. **æ‰§è¡Œç»“æžœå­˜å‚¨** (ä¸­ä¼˜å…ˆçº§)
   - [ ] æ‰©å±• `TestResult` æ¨¡åž‹
   - [ ] æ·»åŠ  `loopIterations` å­—æ®µ
   - [ ] æ·»åŠ  `executedBranchIndex` å­—æ®µ
   - [ ] æ·»åŠ  `childResults` é€’å½’ç»“æž„
   - [ ] æ•°æ®åº“ Schema è¿ç§»

5. **WebSocket å®žæ—¶æŽ¨é€** (ä¸­ä¼˜å…ˆçº§)
   - [ ] Loop è¿­ä»£å¼€å§‹/å®Œæˆäº‹ä»¶
   - [ ] Branch æ¡ä»¶è¯„ä¼°äº‹ä»¶
   - [ ] å˜é‡æ›´æ–°äº‹ä»¶
   - [ ] å­æ­¥éª¤æ‰§è¡Œäº‹ä»¶

6. **ExecutionView é›†æˆ** (ä½Žä¼˜å…ˆçº§)
   - [ ] å‰ç«¯è¿žæŽ¥ WebSocket
   - [ ] å®žæ—¶æ˜¾ç¤ºå¾ªçŽ¯è¿›åº¦
   - [ ] æ˜¾ç¤ºæ‰§è¡Œçš„åˆ†æ”¯è·¯å¾„
   - [ ] å˜é‡æ± å®žæ—¶æ›´æ–°

### æŠ€æœ¯æŒ‘æˆ˜
1. **å˜é‡æ’å€¼å¼•æ“Ž**: éœ€è¦æ”¯æŒå¤æ‚è¡¨è¾¾å¼ (`{{response.body.users}}`)
2. **æ¡ä»¶è¯„ä¼°**: éœ€è¦å®žçŽ°è¡¨è¾¾å¼è§£æžå™¨ (å¯è€ƒè™‘ä½¿ç”¨ `github.com/antonmedv/expr`)
3. **åµŒå¥—æ‰§è¡Œ**: é€’å½’æ‰§è¡Œå­æ­¥éª¤ï¼Œç»´æŠ¤æ­£ç¡®çš„å˜é‡ä½œç”¨åŸŸ
4. **é”™è¯¯å¤„ç†**: å¾ªçŽ¯/åˆ†æ”¯ä¸­çš„é”™è¯¯ä¼ æ’­ç­–ç•¥

### é¢„è®¡å·¥ä½œé‡
- **Loop æ‰§è¡Œ**: 2-3 å¤©
- **Branch æ‰§è¡Œ**: 1-2 å¤©
- **å˜é‡ç®¡ç†**: 2-3 å¤©
- **ç»“æžœå­˜å‚¨**: 1 å¤©
- **WebSocket**: 1-2 å¤©
- **æ€»è®¡**: 7-11 å¤©

---

## ðŸ“ é‡è¦è¯´æ˜Ž

### Phase 7 vs Phase 8
- **Phase 7 (å·²å®Œæˆ)**: æ•°æ®**å­˜å‚¨å’Œè¯»å–** - å‰ç«¯å¯ä»¥ä¿å­˜ loop/branch é…ç½®
- **Phase 8 (å¾…å¼€å§‹)**: æ•°æ®**æ‰§è¡Œ** - åŽç«¯èƒ½å¤Ÿå®žé™…è¿è¡Œ loop/branch é€»è¾‘

### å½“å‰çŠ¶æ€
âœ… **ç”¨æˆ·çŽ°åœ¨å¯ä»¥**:
1. åœ¨å‰ç«¯ UI é…ç½® loop å’Œ branch
2. ä¿å­˜é…ç½®åˆ°åŽç«¯æ•°æ®åº“
3. åˆ·æ–°é¡µé¢åŽé…ç½®å®Œæ•´è¿˜åŽŸ
4. é€šè¿‡ API æŸ¥çœ‹å®Œæ•´çš„é…ç½®æ•°æ®

âŒ **ç”¨æˆ·æš‚æ—¶ä¸èƒ½**:
1. æ‰§è¡Œå¸¦æœ‰ loop çš„æµ‹è¯•ç”¨ä¾‹ (ä¼šå¿½ç•¥ loop é…ç½®)
2. æ‰§è¡Œå¸¦æœ‰ branch çš„æµ‹è¯•ç”¨ä¾‹ (ä¼šå¿½ç•¥ branch é…ç½®)
3. çœ‹åˆ°å¾ªçŽ¯è¿­ä»£çš„å®žæ—¶è¿›åº¦
4. çœ‹åˆ°åˆ†æ”¯é€‰æ‹©çš„æ‰§è¡Œè·¯å¾„

### å»ºè®®
1. **ç«‹å³å¯ç”¨**: å‰ç«¯å›¢é˜Ÿå¯ä»¥ç»§ç»­å®Œå–„ StepEditor UI
2. **å¾…æ‰§è¡Œå¼•æ“Ž**: æµ‹è¯•æ‰§è¡Œéœ€è¦ç­‰å¾… Phase 8 å®Œæˆ
3. **æ¸è¿›å¼äº¤ä»˜**: Phase 8 å¯ä»¥åˆ†æ­¥éª¤äº¤ä»˜ (å…ˆ Count Loop, å† Branch, æœ€åŽ WebSocket)

---

## ðŸŽ“ ç»éªŒæ€»ç»“

### æˆåŠŸå› ç´ 
1. âœ… ä½¿ç”¨çŽ°æœ‰çš„ `steps` å­—æ®µï¼Œæ— éœ€æ•°æ®åº“è¿ç§»
2. âœ… GORM çš„ `JSONArray` ç±»åž‹å®Œç¾Žæ”¯æŒåµŒå¥—ç»“æž„
3. âœ… å‰åŽç«¯ç±»åž‹å®šä¹‰æå‰å¯¹é½ (TypeScript vs Go)
4. âœ… é€šè¿‡ curl æµ‹è¯•å¿«é€ŸéªŒè¯ API æ­£ç¡®æ€§

### æ”¹è¿›å»ºè®®
1. å‰ç«¯ä¾èµ–ç®¡ç†: å®šæœŸ `npm install` ä¿æŒä¾èµ–æœ€æ–°
2. API æµ‹è¯•: å¯è€ƒè™‘ç¼–å†™è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
3. æ•°æ®åº“å¤‡ä»½: æµ‹è¯•å‰å¤‡ä»½æ•°æ®åº“ï¼Œé¿å…è¯¯æ“ä½œ

---

## ðŸ“ž è”ç³»ä¸Žåé¦ˆ

å¦‚æœ‰é—®é¢˜è¯·å‚è€ƒ:
- é¡¹ç›®çŠ¶æ€: `TESTCASE_REDESIGN_STATUS.md`
- æµ‹è¯•æ–‡æ¡£: `LOOP_BRANCH_TEST_CASES.md`
- æµ‹è¯•æŠ¥å‘Š: `TEST_REPORT_2025-11-24.md`

---

*Phase 7 å®ŒæˆæŠ¥å‘Š - Claude Code ç”Ÿæˆ*
*å®Œæˆæ—¶é—´: 2025-11-24 11:05*
