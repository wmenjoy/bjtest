# 测试场景知识库

> 本文件告诉 AI 应该为代码生成哪些测试场景

## 1. 通用测试场景分类

### 1.1 Happy Path（正常路径）- 必须覆盖

每个函数至少有一个正常路径测试：
- 所有输入有效
- 所有前置条件满足
- 返回预期结果

```
场景: {Function}_Success 或 {Function}_ValidInput
断言: 无错误 + 返回值正确
```

### 1.2 Error Handling（错误处理）- 必须覆盖

每个可能失败的操作都需要测试：

| 错误类型 | 测试场景 | 断言 |
|---------|---------|------|
| 输入验证失败 | 空值、格式错误、超出范围 | 返回验证错误 |
| 依赖失败 | 数据库错误、网络超时、服务不可用 | 返回适当错误，不崩溃 |
| 业务规则违反 | 权限不足、状态不允许、资源不存在 | 返回业务错误 |

### 1.3 Edge Cases（边界情况）- 应该覆盖

根据参数类型自动识别边界：

**数值类型**:
```
- 0 (零值)
- -1 (负数，如果不允许)
- 1 (最小正数)
- MAX_VALUE (最大值)
- MIN_VALUE (最小值)
- 边界值 N±1
```

**字符串类型**:
```
- "" (空字符串)
- " " (空白字符)
- 单字符 "a"
- 超长字符串 (1000+ 字符)
- 特殊字符 !@#$%^&*()
- Unicode 字符 (中文、emoji)
- 换行符 \n \r
```

**集合类型**:
```
- [] (空集合)
- [item] (单元素)
- [重复元素]
- [大量元素] (1000+)
- nil/null
```

**时间类型**:
```
- 过去时间
- 未来时间
- 边界时间 (00:00:00, 23:59:59)
- 时区边界
- 闰年日期
```

### 1.4 Security（安全测试）- 高风险代码必须覆盖

当代码处理用户输入时：

| 威胁 | 测试场景 | 输入示例 |
|------|---------|---------|
| SQL 注入 | 恶意 SQL | `' OR '1'='1` |
| XSS | 恶意脚本 | `<script>alert(1)</script>` |
| 路径遍历 | 恶意路径 | `../../../etc/passwd` |
| 命令注入 | 恶意命令 | `; rm -rf /` |

### 1.5 Concurrency（并发测试）- 共享资源必须覆盖

当代码涉及共享状态时：
- 并发读取
- 并发写入
- 读写并发
- 死锁检测

---

## 2. 根据代码特征选择场景

### 2.1 CRUD 操作

```yaml
Create:
  必测:
    - 有效数据创建成功
    - 重复数据拒绝
    - 必填字段缺失
    - 字段格式验证
  建议:
    - 并发创建
    - 大数据量

Read:
  必测:
    - ID 存在返回数据
    - ID 不存在返回空/错误
    - 分页正确
  建议:
    - 过滤条件
    - 排序

Update:
  必测:
    - 存在的记录更新成功
    - 不存在的记录返回错误
    - 并发更新冲突
  建议:
    - 部分更新
    - 乐观锁

Delete:
  必测:
    - 存在的记录删除成功
    - 不存在的记录处理
    - 有依赖的记录
  建议:
    - 软删除验证
    - 级联删除
```

### 2.2 认证授权

```yaml
认证:
  必测:
    - 有效凭证登录成功
    - 无效密码拒绝
    - 用户不存在
    - 账户锁定
    - Token 过期
  安全:
    - SQL 注入
    - 暴力破解保护
    - 密码不明文返回

授权:
  必测:
    - 有权限允许
    - 无权限拒绝
    - 角色继承
  安全:
    - 越权访问
    - 权限提升
```

### 2.3 HTTP API

```yaml
请求处理:
  必测:
    - 正确请求返回 200
    - 无效请求返回 400
    - 未认证返回 401
    - 无权限返回 403
    - 不存在返回 404
    - 服务器错误返回 500
  建议:
    - 请求超时
    - 并发请求
    - 大请求体

响应格式:
  必测:
    - JSON 格式正确
    - 字段完整
    - 错误信息有意义
```

### 2.4 外部服务调用

```yaml
正常场景:
  - 服务可用，返回成功
  - 响应数据正确解析

失败场景:
  - 连接超时
  - 服务不可用
  - 响应格式错误
  - 部分失败（批量操作）

重试场景:
  - 可重试错误
  - 不可重试错误
  - 达到最大重试
```

---

## 3. 测试数量指导

### 3.1 基于复杂度

```
圈复杂度 1-5:   2-5 个测试
圈复杂度 6-10:  5-10 个测试
圈复杂度 11-20: 10-20 个测试
圈复杂度 >20:   考虑重构
```

### 3.2 基于覆盖率目标

```
目标 80%: 覆盖所有主要分支
目标 90%: 覆盖所有分支 + 关键边界
目标 95%: 覆盖所有路径 + 所有边界
```

---

## 4. AI 生成检查清单

生成测试后，AI 应自检：

```markdown
□ 是否覆盖了正常路径？
□ 是否覆盖了所有错误返回？
□ 是否覆盖了参数边界？
□ 如果有用户输入，是否有安全测试？
□ 如果有外部依赖，是否 mock 了？
□ 测试名称是否描述了场景？
□ 断言是否充分？
□ 是否遵循了项目代码风格？
```
