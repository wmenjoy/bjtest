#!/bin/bash
# pre-push hook for coverage check
# å®‰è£…: cp pre-push .git/hooks/ && chmod +x .git/hooks/pre-push

set -e

echo "ğŸš€ AI Test Generation Pre-push Hook"

# é…ç½®
MIN_COVERAGE=80
RUN_TESTS=true
CHECK_COVERAGE=true

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# æ£€æµ‹é¡¹ç›®è¯­è¨€å¹¶è¿è¡Œæµ‹è¯•
run_tests() {
    if [ -f "go.mod" ]; then
        echo "ğŸ“‹ è¿è¡Œ Go æµ‹è¯•..."
        go test ./... -v

        if [ "$CHECK_COVERAGE" = true ]; then
            echo "ğŸ“Š æ£€æŸ¥è¦†ç›–ç‡..."
            COVERAGE=$(go test ./... -cover | grep -oP 'coverage: \K[0-9.]+' | tail -1)
            check_coverage "$COVERAGE"
        fi

    elif [ -f "pom.xml" ]; then
        echo "ğŸ“‹ è¿è¡Œ Maven æµ‹è¯•..."
        mvn test -q

        if [ "$CHECK_COVERAGE" = true ]; then
            echo "ğŸ“Š æ£€æŸ¥è¦†ç›–ç‡..."
            mvn jacoco:report -q
            # è§£æ jacoco æŠ¥å‘Šè·å–è¦†ç›–ç‡
        fi

    elif [ -f "package.json" ]; then
        echo "ğŸ“‹ è¿è¡Œ npm æµ‹è¯•..."
        npm test -- --coverage --watchAll=false

        if [ "$CHECK_COVERAGE" = true ]; then
            # Jest coverage é€šå¸¸ä¼šè‡ªåŠ¨è¾“å‡º
            echo "ğŸ“Š è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ"
        fi

    elif [ -f "CMakeLists.txt" ]; then
        echo "ğŸ“‹ è¿è¡Œ C++ æµ‹è¯•..."
        if [ -d "build" ]; then
            cd build && ctest --output-on-failure
        else
            echo -e "${YELLOW}âš ï¸  è¯·å…ˆæ„å»ºé¡¹ç›®${NC}"
        fi
    fi
}

# æ£€æŸ¥è¦†ç›–ç‡
check_coverage() {
    local coverage=$1

    if [ -z "$coverage" ]; then
        echo -e "${YELLOW}âš ï¸  æ— æ³•è·å–è¦†ç›–ç‡æ•°æ®${NC}"
        return
    fi

    local coverage_int=${coverage%.*}

    if [ "$coverage_int" -lt "$MIN_COVERAGE" ]; then
        echo -e "${RED}âŒ è¦†ç›–ç‡ ${coverage}% ä½äºæœ€ä½è¦æ±‚ ${MIN_COVERAGE}%${NC}"
        echo ""
        echo "æç¤º: ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ†æè¦†ç›–ç‡ç¼ºå£:"
        echo "  /analyze-coverage --threshold $MIN_COVERAGE"
        echo ""
        exit 1
    else
        echo -e "${GREEN}âœ… è¦†ç›–ç‡ ${coverage}% >= ${MIN_COVERAGE}%${NC}"
    fi
}

# ä¸»æµç¨‹
main() {
    if [ "$RUN_TESTS" = true ]; then
        run_tests
    fi

    echo -e "${GREEN}âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œæ¨é€ç»§ç»­...${NC}"
}

main
