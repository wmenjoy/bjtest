#!/bin/bash
# commit-msg hook for test-related commits
# 安装: cp commit-msg .git/hooks/ && chmod +x .git/hooks/commit-msg

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# 颜色
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 检查是否是测试相关的提交
if echo "$COMMIT_MSG" | grep -qiE "(test|spec|coverage)"; then
    # 如果提交消息包含测试相关关键字，检查是否有测试文件变更
    TEST_FILES=$(git diff --cached --name-only | grep -E '(_test\.go|Test\.java|\.test\.(ts|tsx|js|jsx)|_test\.cpp)$' || true)

    if [ -z "$TEST_FILES" ]; then
        echo -e "${YELLOW}⚠️  提交消息提到测试，但没有测试文件变更${NC}"
        echo "如果这是预期的，请继续。否则请检查是否遗漏了测试文件。"
    fi
fi

# 检查 TODO 在测试中
TODO_IN_TESTS=$(git diff --cached --name-only | xargs grep -l "TODO" 2>/dev/null | grep -E '(_test\.go|Test\.java|\.test\.(ts|tsx|js|jsx)|_test\.cpp)$' || true)

if [ -n "$TODO_IN_TESTS" ]; then
    echo -e "${YELLOW}⚠️  以下测试文件包含 TODO:${NC}"
    echo "$TODO_IN_TESTS"
    echo "建议: 完成 TODO 或创建 issue 跟踪"
fi

exit 0
