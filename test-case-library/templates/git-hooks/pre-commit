#!/bin/bash
# pre-commit hook for AI test generation
# å®‰è£…: cp pre-commit .git/hooks/ && chmod +x .git/hooks/pre-commit

set -e

echo "ğŸ§ª AI Test Generation Pre-commit Hook"

# é…ç½®
MIN_COVERAGE=80
CHECK_NEW_FILES=true
AUTO_GENERATE=false  # è®¾ä¸º true è‡ªåŠ¨ç”Ÿæˆç¼ºå¤±çš„æµ‹è¯•

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# è·å–ä¿®æ”¹çš„æºæ–‡ä»¶
get_changed_source_files() {
    local lang=$1
    case $lang in
        go)
            git diff --cached --name-only --diff-filter=ACM | grep '\.go$' | grep -v '_test\.go$' || true
            ;;
        java)
            git diff --cached --name-only --diff-filter=ACM | grep '\.java$' | grep -v 'Test\.java$' || true
            ;;
        ts|typescript)
            git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | grep -v '\.test\.' | grep -v '\.spec\.' || true
            ;;
        cpp)
            git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|cc|cxx|hpp|h)$' | grep -v '_test\.' || true
            ;;
    esac
}

# æ£€æŸ¥æµ‹è¯•æ–‡ä»¶æ˜¯å¦å­˜åœ¨
check_test_exists() {
    local source_file=$1
    local lang=$2
    local test_file=""

    case $lang in
        go)
            test_file="${source_file%.go}_test.go"
            ;;
        java)
            test_file="${source_file%.java}Test.java"
            ;;
        ts|typescript)
            local base="${source_file%.*}"
            local ext="${source_file##*.}"
            test_file="${base}.test.${ext}"
            ;;
        cpp)
            local base="${source_file%.*}"
            test_file="${base}_test.cpp"
            ;;
    esac

    if [ -f "$test_file" ]; then
        return 0
    else
        return 1
    fi
}

# æ£€æµ‹é¡¹ç›®è¯­è¨€
detect_language() {
    if [ -f "go.mod" ]; then
        echo "go"
    elif [ -f "pom.xml" ] || [ -f "build.gradle" ]; then
        echo "java"
    elif [ -f "package.json" ]; then
        echo "ts"
    elif [ -f "CMakeLists.txt" ] || [ -f "Makefile" ]; then
        echo "cpp"
    else
        echo "unknown"
    fi
}

# ä¸»æµç¨‹
main() {
    local lang=$(detect_language)

    if [ "$lang" = "unknown" ]; then
        echo -e "${YELLOW}âš ï¸  æ— æ³•æ£€æµ‹é¡¹ç›®è¯­è¨€ï¼Œè·³è¿‡æµ‹è¯•æ£€æŸ¥${NC}"
        exit 0
    fi

    echo "ğŸ“ æ£€æµ‹åˆ°é¡¹ç›®è¯­è¨€: $lang"

    # è·å–ä¿®æ”¹çš„æºæ–‡ä»¶
    local changed_files=$(get_changed_source_files $lang)

    if [ -z "$changed_files" ]; then
        echo -e "${GREEN}âœ… æ²¡æœ‰éœ€è¦æ£€æŸ¥çš„æºæ–‡ä»¶${NC}"
        exit 0
    fi

    local missing_tests=()
    local files_count=0
    local missing_count=0

    echo "ğŸ” æ£€æŸ¥æµ‹è¯•è¦†ç›–..."

    for file in $changed_files; do
        ((files_count++))
        if ! check_test_exists "$file" "$lang"; then
            missing_tests+=("$file")
            ((missing_count++))
            echo -e "${RED}  âœ— $file - ç¼ºå°‘æµ‹è¯•æ–‡ä»¶${NC}"
        else
            echo -e "${GREEN}  âœ“ $file${NC}"
        fi
    done

    echo ""
    echo "ğŸ“Š æ£€æŸ¥ç»“æœ: $files_count ä¸ªæ–‡ä»¶, $missing_count ä¸ªç¼ºå°‘æµ‹è¯•"

    if [ $missing_count -gt 0 ]; then
        echo ""
        echo -e "${YELLOW}ç¼ºå°‘æµ‹è¯•çš„æ–‡ä»¶:${NC}"
        for file in "${missing_tests[@]}"; do
            echo "  - $file"
        done
        echo ""

        if [ "$AUTO_GENERATE" = true ]; then
            echo -e "${YELLOW}ğŸ¤– è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•æ–‡ä»¶...${NC}"
            for file in "${missing_tests[@]}"; do
                echo "  ç”Ÿæˆ: $file"
                # è°ƒç”¨ Claude Code å‘½ä»¤ç”Ÿæˆæµ‹è¯•
                # claude-code /generate-tests --file "$file" --output auto
            done
        else
            echo -e "${RED}âŒ æäº¤è¢«é˜»æ­¢: è¯·ä¸ºä»¥ä¸Šæ–‡ä»¶æ·»åŠ æµ‹è¯•${NC}"
            echo ""
            echo "æç¤º: ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆæµ‹è¯•:"
            echo "  /generate-tests --file <filename>"
            echo ""
            echo "æˆ–è®¾ç½® AUTO_GENERATE=true è‡ªåŠ¨ç”Ÿæˆ"
            exit 1
        fi
    fi

    echo -e "${GREEN}âœ… æµ‹è¯•æ£€æŸ¥é€šè¿‡${NC}"
}

main
