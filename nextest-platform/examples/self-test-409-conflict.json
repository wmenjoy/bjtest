{
  "workflowId": "self-test-409-conflict",
  "name": "409 Conflict Error Tests",
  "version": "1.0.0",
  "description": "System tests for 409 Conflict responses - verifies business rule conflicts (按照HTTP规范，资源冲突或业务规则冲突必须返回409)",
  "definition": {
    "variables": {
      "baseUrl": "http://localhost:8090/api"
    },
    "steps": {
      "step01_createGroup": {
        "id": "step01_createGroup",
        "name": "Create Test Group for Conflict Tests",
        "type": "http",
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/groups",
          "headers": {
            "Content-Type": "application/json"
          },
          "body": {
            "groupId": "conflict-test-group",
            "name": "Conflict Test Group",
            "description": "For testing 409 scenarios"
          }
        }
      },
      "step02_assertGroupCreated": {
        "id": "step02_assertGroupCreated",
        "name": "Verify Group Created",
        "type": "assert",
        "dependsOn": [
          "step01_createGroup"
        ],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step01_createGroup.response.statusCode}}",
              "expected": 201,
              "message": "Group should be created successfully"
            }
          ]
        },
        "onError": "continue"
      },
      "step03_createDuplicateGroup": {
        "id": "step03_createDuplicateGroup",
        "name": "Create Duplicate Group (Same groupId)",
        "type": "http",
        "dependsOn": [
          "step02_assertGroupCreated"
        ],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/groups",
          "headers": {
            "Content-Type": "application/json"
          },
          "body": {
            "groupId": "conflict-test-group",
            "name": "Duplicate Group",
            "description": "This should fail with 409"
          }
        }
      },
      "step04_assert409Group": {
        "id": "step04_assert409Group",
        "name": "Assert 409 for Duplicate Group",
        "type": "assert",
        "dependsOn": [
          "step03_createDuplicateGroup"
        ],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step03_createDuplicateGroup.response.statusCode}}",
              "expected": 409,
              "message": "POST /api/groups with existing groupId must return 409"
            }
          ]
        },
        "onError": "continue"
      },
      "step05_createTest": {
        "id": "step05_createTest",
        "name": "Create Test Case",
        "type": "http",
        "dependsOn": [
          "step04_assert409Group"
        ],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/tests",
          "headers": {
            "Content-Type": "application/json"
          },
          "body": {
            "testId": "conflict-test-case",
            "name": "Conflict Test Case",
            "type": "http",
            "groupId": "conflict-test-group"
          }
        }
      },
      "step06_assertTestCreated": {
        "id": "step06_assertTestCreated",
        "name": "Verify Test Created",
        "type": "assert",
        "dependsOn": [
          "step05_createTest"
        ],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step05_createTest.response.statusCode}}",
              "expected": 201,
              "message": "Test should be created successfully"
            }
          ]
        },
        "onError": "continue"
      },
      "step07_createDuplicateTest": {
        "id": "step07_createDuplicateTest",
        "name": "Create Duplicate Test (Same testId)",
        "type": "http",
        "dependsOn": [
          "step06_assertTestCreated"
        ],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/tests",
          "headers": {
            "Content-Type": "application/json"
          },
          "body": {
            "testId": "conflict-test-case",
            "name": "Duplicate Test",
            "type": "http",
            "groupId": "conflict-test-group"
          }
        }
      },
      "step08_assert409Test": {
        "id": "step08_assert409Test",
        "name": "Assert 409 for Duplicate Test",
        "type": "assert",
        "dependsOn": [
          "step07_createDuplicateTest"
        ],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step07_createDuplicateTest.response.statusCode}}",
              "expected": 409,
              "message": "POST /api/tests with existing testId must return 409"
            }
          ]
        },
        "onError": "continue"
      },
      "step09_deleteGroupWithTests": {
        "id": "step09_deleteGroupWithTests",
        "name": "Delete Group with Child Tests",
        "type": "http",
        "dependsOn": [
          "step08_assert409Test"
        ],
        "config": {
          "method": "DELETE",
          "url": "{{baseUrl}}/groups/conflict-test-group"
        }
      },
      "step10_assert409DeleteGroup": {
        "id": "step10_assert409DeleteGroup",
        "name": "Assert 409 for Delete Group with Tests",
        "type": "assert",
        "dependsOn": [
          "step09_deleteGroupWithTests"
        ],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step09_deleteGroupWithTests.response.statusCode}}",
              "expected": 409,
              "message": "DELETE /api/groups/{id} with child tests must return 409 (business rule: cannot delete group with tests)"
            }
          ]
        },
        "onError": "continue"
      },
      "step11_createEnv": {
        "id": "step11_createEnv",
        "name": "Create Test Environment",
        "type": "http",
        "dependsOn": [
          "step10_assert409DeleteGroup"
        ],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/environments",
          "headers": {
            "Content-Type": "application/json"
          },
          "body": {
            "envId": "conflict-test-env",
            "name": "Conflict Test Environment",
            "description": "For testing 409 scenarios"
          }
        }
      },
      "step12_assertEnvCreated": {
        "id": "step12_assertEnvCreated",
        "name": "Verify Environment Created",
        "type": "assert",
        "dependsOn": [
          "step11_createEnv"
        ],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step11_createEnv.response.statusCode}}",
              "expected": 201,
              "message": "Environment should be created successfully"
            }
          ]
        },
        "onError": "continue"
      },
      "step13_activateEnv": {
        "id": "step13_activateEnv",
        "name": "Activate Test Environment",
        "type": "http",
        "dependsOn": [
          "step12_assertEnvCreated"
        ],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/environments/conflict-test-env/activate"
        }
      },
      "step14_assertEnvActivated": {
        "id": "step14_assertEnvActivated",
        "name": "Verify Environment Activated",
        "type": "assert",
        "dependsOn": [
          "step13_activateEnv"
        ],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step13_activateEnv.response.statusCode}}",
              "expected": 200,
              "message": "Environment should be activated successfully"
            }
          ]
        },
        "onError": "continue"
      },
      "step15_deleteActiveEnv": {
        "id": "step15_deleteActiveEnv",
        "name": "Delete Active Environment",
        "type": "http",
        "dependsOn": [
          "step14_assertEnvActivated"
        ],
        "config": {
          "method": "DELETE",
          "url": "{{baseUrl}}/environments/conflict-test-env"
        }
      },
      "step16_assert409DeleteActiveEnv": {
        "id": "step16_assert409DeleteActiveEnv",
        "name": "Assert 409 for Delete Active Environment",
        "type": "assert",
        "dependsOn": [
          "step15_deleteActiveEnv"
        ],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step15_deleteActiveEnv.response.statusCode}}",
              "expected": 409,
              "message": "DELETE /api/environments/{id} for active environment must return 409 (SPEC VIOLATION: currently returns 500)"
            }
          ]
        },
        "onError": "continue"
      },
      "step17_createDuplicateEnv": {
        "id": "step17_createDuplicateEnv",
        "name": "Create Duplicate Environment",
        "type": "http",
        "dependsOn": [
          "step16_assert409DeleteActiveEnv"
        ],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/environments",
          "headers": {
            "Content-Type": "application/json"
          },
          "body": {
            "envId": "conflict-test-env",
            "name": "Duplicate Environment",
            "description": "This should fail with 409"
          }
        }
      },
      "step18_assert409DuplicateEnv": {
        "id": "step18_assert409DuplicateEnv",
        "name": "Assert 409 for Duplicate Environment",
        "type": "assert",
        "dependsOn": [
          "step17_createDuplicateEnv"
        ],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step17_createDuplicateEnv.response.statusCode}}",
              "expected": 409,
              "message": "POST /api/environments with existing envId must return 409"
            }
          ]
        },
        "onError": "continue"
      },
      "step19_cleanup_activateDefault": {
        "id": "step19_cleanup_activateDefault",
        "name": "Cleanup: Activate Default Environment",
        "type": "http",
        "dependsOn": [
          "step18_assert409DuplicateEnv"
        ],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/environments/default/activate"
        }
      },
      "step20_cleanup_deleteEnv": {
        "id": "step20_cleanup_deleteEnv",
        "name": "Cleanup: Delete Test Environment",
        "type": "http",
        "dependsOn": [
          "step19_cleanup_activateDefault"
        ],
        "config": {
          "method": "DELETE",
          "url": "{{baseUrl}}/environments/conflict-test-env"
        }
      },
      "step21_cleanup_deleteTest": {
        "id": "step21_cleanup_deleteTest",
        "name": "Cleanup: Delete Test Case",
        "type": "http",
        "dependsOn": [
          "step20_cleanup_deleteEnv"
        ],
        "config": {
          "method": "DELETE",
          "url": "{{baseUrl}}/tests/conflict-test-case"
        }
      },
      "step22_cleanup_deleteGroup": {
        "id": "step22_cleanup_deleteGroup",
        "name": "Cleanup: Delete Test Group",
        "type": "http",
        "dependsOn": [
          "step21_cleanup_deleteTest"
        ],
        "config": {
          "method": "DELETE",
          "url": "{{baseUrl}}/groups/conflict-test-group"
        }
      }
    }
  }
}