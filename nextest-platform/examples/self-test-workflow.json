{
  "name": "Platform Self-Test Workflow",
  "version": "1.0.0",
  "description": "Comprehensive self-test of platform APIs and features",
  "variables": {
    "baseUrl": "http://localhost:8090/api",
    "testGroupId": "self-test-group",
    "testCaseId": "",
    "workflowId": "",
    "dbPath": "./data/test_management.db"
  },
  "steps": {
    "createTestGroup": {
      "id": "createTestGroup",
      "name": "Create Test Group",
      "type": "http",
      "config": {
        "method": "POST",
        "url": "{{baseUrl}}/groups",
        "headers": {
          "Content-Type": "application/json"
        },
        "body": {
          "groupId": "{{testGroupId}}",
          "name": "Self-Test Group",
          "description": "Group for self-testing"
        }
      },
      "output": {
        "groupId": "groupId"
      }
    },
    "assertGroupCreated": {
      "id": "assertGroupCreated",
      "name": "Assert Group Created",
      "type": "assert",
      "dependsOn": [
        "createTestGroup"
      ],
      "config": {
        "assertions": [
          {
            "type": "equals",
            "actual": "{{createTestGroup.response.groupId}}",
            "expected": "{{testGroupId}}",
            "message": "Group ID should match"
          },
          {
            "type": "exists",
            "actual": "{{createTestGroup.response.name}}",
            "message": "Group name should exist"
          }
        ]
      }
    },
    "createTestCase": {
      "id": "createTestCase",
      "name": "Create HTTP Test Case",
      "type": "http",
      "dependsOn": [
        "assertGroupCreated"
      ],
      "config": {
        "method": "POST",
        "url": "{{baseUrl}}/tests",
        "headers": {
          "Content-Type": "application/json"
        },
        "body": {
          "name": "Sample HTTP Test",
          "type": "http",
          "groupId": "{{testGroupId}}",
          "http_config": {
            "method": "GET",
            "url": "https://httpbin.org/get",
            "headers": {},
            "timeout": 5000
          },
          "assertions": []
        }
      },
      "output": {
        "testCaseId": "testId"
      }
    },
    "verifyTestCaseInDB": {
      "id": "verifyTestCaseInDB",
      "name": "Verify Test Case in Database",
      "type": "database",
      "dependsOn": [
        "createTestCase"
      ],
      "config": {
        "driver": "sqlite3",
        "dsn": "{{dbPath}}",
        "queryType": "select",
        "query": "SELECT test_id, name, type, group_id FROM test_cases WHERE test_id = ? AND deleted_at IS NULL",
        "args": [
          "{{createTestCase.response.testId}}"
        ]
      },
      "output": {
        "dbRecord": "rows[0]"
      }
    },
    "assertTestCaseInDB": {
      "id": "assertTestCaseInDB",
      "name": "Assert Test Case Exists in DB",
      "type": "assert",
      "dependsOn": [
        "verifyTestCaseInDB"
      ],
      "config": {
        "assertions": [
          {
            "type": "equals",
            "actual": "{{verifyTestCaseInDB.rows}}",
            "expected": 1,
            "path": "length",
            "message": "Should find exactly 1 test case"
          },
          {
            "type": "equals",
            "actual": "{{verifyTestCaseInDB.rows[0].type}}",
            "expected": "http",
            "message": "Test case type should be http"
          },
          {
            "type": "equals",
            "actual": "{{verifyTestCaseInDB.rows[0].groupId}}",
            "expected": "{{testGroupId}}",
            "message": "Group ID should match"
          }
        ]
      }
    },
    "getTestCase": {
      "id": "getTestCase",
      "name": "Get Test Case Details",
      "type": "http",
      "dependsOn": [
        "assertTestCaseInDB"
      ],
      "config": {
        "method": "GET",
        "url": "{{baseUrl}}/tests/{{createTestCase.response.testId}}",
        "headers": {
          "Content-Type": "application/json"
        }
      }
    },
    "processTestData": {
      "id": "processTestData",
      "name": "Process Test Data with Python",
      "type": "script",
      "dependsOn": [
        "getTestCase"
      ],
      "config": {
        "language": "python",
        "script": "import json\n\ntest_case = context.get('getTestCase', {})\nresponse = test_case.get('response', {})\n\nresult = {\n    'test_id': response.get('test_id'),\n    'test_name': response.get('name'),\n    'test_type': response.get('type'),\n    'is_valid': response.get('test_id') is not None and len(response.get('name', '')) > 0\n}\n\nprint(json.dumps(result))",
        "timeout": 10
      },
      "output": {
        "processedData": "output"
      }
    },
    "assertProcessedData": {
      "id": "assertProcessedData",
      "name": "Assert Processed Data",
      "type": "assert",
      "dependsOn": [
        "processTestData"
      ],
      "config": {
        "assertions": [
          {
            "type": "equals",
            "actual": "{{processTestData.output.is_valid}}",
            "expected": true,
            "message": "Processed data should be valid"
          },
          {
            "type": "equals",
            "actual": "{{processTestData.output.test_type}}",
            "expected": "http",
            "message": "Test type should be http"
          }
        ]
      }
    },
    "executeTestCase": {
      "id": "executeTestCase",
      "name": "Execute Test Case",
      "type": "http",
      "dependsOn": [
        "assertProcessedData"
      ],
      "config": {
        "method": "POST",
        "url": "{{baseUrl}}/tests/{{createTestCase.response.testId}}/execute",
        "headers": {
          "Content-Type": "application/json"
        }
      }
    },
    "assertTestExecution": {
      "id": "assertTestExecution",
      "name": "Assert Test Execution Success",
      "type": "assert",
      "dependsOn": [
        "executeTestCase"
      ],
      "config": {
        "assertions": [
          {
            "type": "exists",
            "actual": "{{executeTestCase.response.result_id}}",
            "message": "Execution should return result_id"
          },
          {
            "type": "contains",
            "actual": "{{executeTestCase.response.status}}",
            "expected": "passed",
            "message": "Test should pass"
          }
        ]
      }
    },
    "countTestResults": {
      "id": "countTestResults",
      "name": "Count Test Results in DB",
      "type": "database",
      "dependsOn": [
        "assertTestExecution"
      ],
      "config": {
        "driver": "sqlite3",
        "dsn": "{{dbPath}}",
        "queryType": "select",
        "query": "SELECT COUNT(*) as count FROM test_results WHERE test_id = ?",
        "args": [
          "{{createTestCase.response.testId}}"
        ]
      }
    },
    "assertResultsCount": {
      "id": "assertResultsCount",
      "name": "Assert Results Count",
      "type": "assert",
      "dependsOn": [
        "countTestResults"
      ],
      "config": {
        "assertions": [
          {
            "type": "greaterThan",
            "actual": "{{countTestResults.rows[0].count}}",
            "expected": 0,
            "message": "Should have at least 1 test result"
          }
        ]
      }
    },
    "deleteTestCase": {
      "id": "deleteTestCase",
      "name": "Delete Test Case",
      "type": "http",
      "dependsOn": [
        "assertResultsCount"
      ],
      "config": {
        "method": "DELETE",
        "url": "{{baseUrl}}/tests/{{createTestCase.response.testId}}",
        "headers": {
          "Content-Type": "application/json"
        }
      }
    },
    "verifyDeletion": {
      "id": "verifyDeletion",
      "name": "Verify Test Case Deleted",
      "type": "database",
      "dependsOn": [
        "deleteTestCase"
      ],
      "config": {
        "driver": "sqlite3",
        "dsn": "{{dbPath}}",
        "queryType": "select",
        "query": "SELECT COUNT(*) as count FROM test_cases WHERE test_id = ? AND deleted_at IS NULL",
        "args": [
          "{{createTestCase.response.testId}}"
        ]
      }
    },
    "assertDeletion": {
      "id": "assertDeletion",
      "name": "Assert Test Case Deleted",
      "type": "assert",
      "dependsOn": [
        "verifyDeletion"
      ],
      "config": {
        "assertions": [
          {
            "type": "equals",
            "actual": "{{verifyDeletion.rows[0].count}}",
            "expected": 0,
            "message": "Test case should be soft-deleted"
          }
        ]
      }
    },
    "cleanupGroup": {
      "id": "cleanupGroup",
      "name": "Cleanup Test Group",
      "type": "http",
      "dependsOn": [
        "assertDeletion"
      ],
      "config": {
        "method": "DELETE",
        "url": "{{baseUrl}}/groups/{{testGroupId}}",
        "headers": {
          "Content-Type": "application/json"
        }
      },
      "onError": "continue"
    }
  }
}
