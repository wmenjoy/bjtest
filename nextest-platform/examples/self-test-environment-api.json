{
  "workflowId": "self-test-environment-api-v2",
  "name": "Environment API Complete Test v2",
  "version": "1.0.0",
  "description": "Complete Environment Management API test",
  "definition": {
    "name": "Environment API Complete Test v2",
    "version": "1.0.0",
    "description": "Tests all Environment API endpoints",
    "variables": {
      "baseUrl": "http://localhost:8090/api",
      "dbPath": "./data/test_management.db",
      "envId": "test-env-api-v2",
      "tenantId": "default",
      "projectId": "default"
    },
    "steps": {
      "step01_cleanup": {
        "id": "step01_cleanup",
        "name": "Cleanup Old Data",
        "type": "database",
        "onError": "continue",
        "config": {
          "driver": "sqlite3",
          "dsn": "{{dbPath}}",
          "queryType": "exec",
          "query": "DELETE FROM environments WHERE env_id = ?",
          "args": ["{{envId}}"]
        }
      },
      "step02_createEnv": {
        "id": "step02_createEnv",
        "name": "Create Environment",
        "type": "http",
        "dependsOn": ["step01_cleanup"],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/environments",
          "headers": {"Content-Type": "application/json"},
          "body": {
            "envId": "{{envId}}",
            "tenantId": "{{tenantId}}",
            "projectId": "{{projectId}}",
            "name": "Test Environment v2",
            "description": "Environment for API testing v2",
            "isActive": false
          }
        }
      },
      "step03_assertCreated": {
        "id": "step03_assertCreated",
        "name": "Assert Environment Created",
        "type": "assert",
        "dependsOn": ["step02_createEnv"],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step02_createEnv.response.statusCode}}",
              "expected": 201,
              "message": "Create should return 201"
            },
            {
              "type": "equals",
              "actual": "{{step02_createEnv.response.body.envId}}",
              "expected": "{{envId}}",
              "message": "envId should match"
            }
          ]
        }
      },
      "step04_getEnv": {
        "id": "step04_getEnv",
        "name": "Get Environment",
        "type": "http",
        "dependsOn": ["step03_assertCreated"],
        "config": {
          "method": "GET",
          "url": "{{baseUrl}}/environments/{{envId}}"
        }
      },
      "step05_listEnvs": {
        "id": "step05_listEnvs",
        "name": "List Environments",
        "type": "http",
        "dependsOn": ["step04_getEnv"],
        "config": {
          "method": "GET",
          "url": "{{baseUrl}}/environments"
        }
      },
      "step06_setVariable": {
        "id": "step06_setVariable",
        "name": "Set Environment Variable",
        "type": "http",
        "dependsOn": ["step05_listEnvs"],
        "config": {
          "method": "PUT",
          "url": "{{baseUrl}}/environments/{{envId}}/variables/TEST_VAR",
          "headers": {"Content-Type": "application/json"},
          "body": {
            "value": "test-value-123"
          }
        }
      },
      "step07_getVariable": {
        "id": "step07_getVariable",
        "name": "Get Environment Variable",
        "type": "http",
        "dependsOn": ["step06_setVariable"],
        "config": {
          "method": "GET",
          "url": "{{baseUrl}}/environments/{{envId}}/variables/TEST_VAR"
        }
      },
      "step08_assertVariable": {
        "id": "step08_assertVariable",
        "name": "Assert Variable Set",
        "type": "assert",
        "dependsOn": ["step07_getVariable"],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step07_getVariable.response.statusCode}}",
              "expected": 200,
              "message": "Get variable should return 200"
            },
            {
              "type": "equals",
              "actual": "{{step07_getVariable.response.body.value}}",
              "expected": "test-value-123",
              "message": "Variable value should match"
            }
          ]
        }
      },
      "step09_activateEnv": {
        "id": "step09_activateEnv",
        "name": "Activate Environment",
        "type": "http",
        "dependsOn": ["step08_assertVariable"],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/environments/{{envId}}/activate"
        }
      },
      "step10_getActive": {
        "id": "step10_getActive",
        "name": "Get Active Environment",
        "type": "http",
        "dependsOn": ["step09_activateEnv"],
        "config": {
          "method": "GET",
          "url": "{{baseUrl}}/environments/active"
        }
      },
      "step11_assertActive": {
        "id": "step11_assertActive",
        "name": "Assert Environment Active",
        "type": "assert",
        "dependsOn": ["step10_getActive"],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step10_getActive.response.statusCode}}",
              "expected": 200,
              "message": "Get active should return 200"
            },
            {
              "type": "equals",
              "actual": "{{step10_getActive.response.body.envId}}",
              "expected": "{{envId}}",
              "message": "Active envId should match"
            }
          ]
        }
      },
      "step12_updateEnv": {
        "id": "step12_updateEnv",
        "name": "Update Environment",
        "type": "http",
        "dependsOn": ["step11_assertActive"],
        "config": {
          "method": "PUT",
          "url": "{{baseUrl}}/environments/{{envId}}",
          "headers": {"Content-Type": "application/json"},
          "body": {
            "name": "Updated Test Environment v2",
            "description": "Updated description v2"
          }
        }
      },
      "step13_assertUpdated": {
        "id": "step13_assertUpdated",
        "name": "Assert Environment Updated",
        "type": "assert",
        "dependsOn": ["step12_updateEnv"],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step12_updateEnv.response.statusCode}}",
              "expected": 200,
              "message": "Update should return 200"
            },
            {
              "type": "equals",
              "actual": "{{step12_updateEnv.response.body.name}}",
              "expected": "Updated Test Environment v2",
              "message": "Name should be updated"
            }
          ]
        }
      },
      "step14_deleteVariable": {
        "id": "step14_deleteVariable",
        "name": "Delete Environment Variable",
        "type": "http",
        "dependsOn": ["step13_assertUpdated"],
        "config": {
          "method": "DELETE",
          "url": "{{baseUrl}}/environments/{{envId}}/variables/TEST_VAR"
        }
      },
      "step15_activateDefault": {
        "id": "step15_activateDefault",
        "name": "Activate Default Environment",
        "type": "http",
        "dependsOn": ["step14_deleteVariable"],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/environments/default/activate"
        }
      },
      "step16_deleteEnv": {
        "id": "step16_deleteEnv",
        "name": "Delete Environment",
        "type": "http",
        "dependsOn": ["step15_activateDefault"],
        "config": {
          "method": "DELETE",
          "url": "{{baseUrl}}/environments/{{envId}}"
        }
      },
      "step17_assertDeleted": {
        "id": "step17_assertDeleted",
        "name": "Assert Environment Deleted",
        "type": "assert",
        "dependsOn": ["step16_deleteEnv"],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step16_deleteEnv.response.statusCode}}",
              "expected": 200,
              "message": "Delete should return 200"
            }
          ]
        }
      }
    }
  }
}
