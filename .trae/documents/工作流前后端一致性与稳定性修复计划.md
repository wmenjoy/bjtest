## 修复目标

* 统一前后端工作流状态/步骤术语与数据模型，消除不一致

* 完善运行步骤与日志类型，替换 `unknown[]`，提高类型安全

* 修正桥接层与组件的模型映射，保证视图与后端结构一一对应

* 提升执行过程的稳定性（WebSocket重连、完成判定、取消执行）

## 具体改动

### 1) 统一状态模型

* 将 `WorkflowRunner` 的完成判定从 `completed` 改为映射后端 `success|failed|cancelled`（/front/components/workflow/WorkflowRunner.tsx）

* 制定统一映射：后端 `BackendWorkflowRun.status` → 前端 `ExecutionStatus`；WS 步骤 `success|failed` → 展示层 `PASSED|FAILED`（/front/services/api/backendTypes.ts, /front/types.ts, /front/components/workflow/UnifiedWorkflowView\.tsx）

### 2) 完善类型定义

* 在 `backendTypes.ts` 增加 `BackendRunStep`、`BackendRunLog`，包含 `stepId/stepName/status/timestamp/message` 等（/front/services/api/backendTypes.ts）

* 将 `workflowApi.getRunSteps/getRunLogs` 的返回类型替换为上述强类型（/front/services/api/workflowApi.ts）

### 3) 桥接层一致性

* 在 `stepToNode` 遇到 `linkedWorkflowId` 时明确设 `node.type = CALL_WORKFLOW`（/front/services/workflowBridge.ts）

* 在 `nodeToStep` 中将 `CALL_WORKFLOW` 正确映射为相应 StepType（目前映射为 `'group'`，统一为专用类型或保留 `'group'` 并补充 `targetWorkflowId`）（/front/services/workflowBridge.ts）

* 增加从后端 `BackendWorkflow.definition.steps(Record)` 到前端 `nodes(ArrayTree)` 的转换与反转换工具（/front/services/workflowBridge.ts 或 /front/services/api/mappers.ts）

### 4) WebSocket 完成与重连稳定性

* 在 Runner 的 `onClose` 区分正常完成与异常断开（结合重连计数/显式 `run_complete` 消息，如无则在 `getRun(runId)` 补拉最终状态）（/front/components/workflow/WorkflowRunner.tsx, /front/services/api/websocket.ts）

* 使用 `stepsRef` 持有最新 Map，避免闭包读取过期状态（/front/components/workflow/WorkflowRunner.tsx）

### 5) 取消执行能力

* 在 `workflowApi` 增加 `cancelRun(runId)`；`Runner.stopExecution` 调用取消并将状态置为 `cancelled`（/front/services/api/workflowApi.ts, /front/components/workflow/WorkflowRunner.tsx）

### 6) 时间戳统一

* 日志统一使用服务器时间（WS `timestamp` 或后端查询结果），本地日志区分来源并避免混排导致排序异常（/front/components/workflow/WorkflowRunner.tsx, /front/components/workflow/WorkflowLogs.tsx）

### 7) 展示与过滤优化

* `WorkflowLogs` 将系统日志与步骤日志分组，步骤过滤不包含 `system`，或提供单独开关（/front/components/workflow/WorkflowLogs.tsx）

### 8) 测试与验证

* 为 `workflowApi` 新增类型与取消接口编写单元测试（mock fetch）

* 为 `WorkflowRunner` 执行与完成、重连、取消路径编写组件测试（渲染与状态断言）

* 为桥接互转（含 CALL\_WORKFLOW）编写一致性测试（输入/输出保持）

## 交付与验证

* 修改完成后运行类型检查与基本测试；用示例页 `WorkflowBridgeExample.tsx` 进行手动验证

* 不修改文档文件，专注代码一致性与稳定性修复

