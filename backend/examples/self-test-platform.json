{
  "workflowId": "platform-self-test-v1",
  "name": "Platform Self-Test Workflow",
  "version": "1.0.0",
  "description": "Comprehensive self-test of platform APIs and features",
  "definition": {
    "name": "Platform Self-Test Workflow",
    "version": "1.0.0",
    "description": "Comprehensive self-test of platform APIs",
    "variables": {
      "baseUrl": "http://localhost:8090/api",
      "testGroupId": "self-test-group-v1",
      "tenantId": "default",
      "projectId": "default",
      "dbPath": "./data/test_management.db"
    },
    "steps": {
      "step01_cleanupOld": {
        "id": "step01_cleanupOld",
        "name": "Cleanup Old Data",
        "type": "database",
        "onError": "continue",
        "config": {
          "driver": "sqlite3",
          "dsn": "{{dbPath}}",
          "queryType": "exec",
          "query": "DELETE FROM test_cases WHERE test_id LIKE 'self-test-%'; DELETE FROM test_groups WHERE group_id = ?",
          "args": ["{{testGroupId}}"]
        }
      },
      "step02_createGroup": {
        "id": "step02_createGroup",
        "name": "Create Test Group",
        "type": "http",
        "dependsOn": ["step01_cleanupOld"],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/groups",
          "headers": {"Content-Type": "application/json"},
          "body": {
            "groupId": "{{testGroupId}}",
            "tenantId": "{{tenantId}}",
            "projectId": "{{projectId}}",
            "name": "Self-Test Group",
            "description": "Group for self-testing"
          }
        }
      },
      "step03_assertGroupCreated": {
        "id": "step03_assertGroupCreated",
        "name": "Assert Group Created",
        "type": "assert",
        "dependsOn": ["step02_createGroup"],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step02_createGroup.response.statusCode}}",
              "expected": 201,
              "message": "Group creation should return 201"
            },
            {
              "type": "equals",
              "actual": "{{step02_createGroup.response.body.groupId}}",
              "expected": "{{testGroupId}}",
              "message": "Group ID should match"
            }
          ]
        }
      },
      "step04_createTestCase": {
        "id": "step04_createTestCase",
        "name": "Create HTTP Test Case",
        "type": "http",
        "dependsOn": ["step03_assertGroupCreated"],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/tests",
          "headers": {"Content-Type": "application/json"},
          "body": {
            "testId": "self-test-http-case",
            "tenantId": "{{tenantId}}",
            "projectId": "{{projectId}}",
            "name": "Sample HTTP Test",
            "type": "http",
            "groupId": "{{testGroupId}}",
            "http": {
              "method": "GET",
              "url": "{{baseUrl}}/groups",
              "headers": {},
              "timeout": 5000
            },
            "assertions": []
          }
        }
      },
      "step05_verifyTestInDB": {
        "id": "step05_verifyTestInDB",
        "name": "Verify Test Case in Database",
        "type": "database",
        "dependsOn": ["step04_createTestCase"],
        "config": {
          "driver": "sqlite3",
          "dsn": "{{dbPath}}",
          "queryType": "select",
          "query": "SELECT test_id, name, type, group_id FROM test_cases WHERE test_id = ? AND deleted_at IS NULL",
          "args": ["self-test-http-case"]
        }
      },
      "step06_assertTestInDB": {
        "id": "step06_assertTestInDB",
        "name": "Assert Test Case in DB",
        "type": "assert",
        "dependsOn": ["step05_verifyTestInDB"],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step04_createTestCase.response.statusCode}}",
              "expected": 201,
              "message": "Test creation should return 201"
            },
            {
              "type": "equals",
              "actual": "{{step05_verifyTestInDB.success}}",
              "expected": true,
              "message": "DB query should succeed"
            },
            {
              "type": "equals",
              "actual": "{{step05_verifyTestInDB.rowCount}}",
              "expected": 1,
              "message": "Should find exactly 1 test case"
            }
          ]
        }
      },
      "step07_getTestCase": {
        "id": "step07_getTestCase",
        "name": "Get Test Case Details",
        "type": "http",
        "dependsOn": ["step06_assertTestInDB"],
        "config": {
          "method": "GET",
          "url": "{{baseUrl}}/tests/self-test-http-case"
        }
      },
      "step08_assertGetTest": {
        "id": "step08_assertGetTest",
        "name": "Assert Get Test Success",
        "type": "assert",
        "dependsOn": ["step07_getTestCase"],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step07_getTestCase.response.statusCode}}",
              "expected": 200,
              "message": "Get test should return 200"
            }
          ]
        }
      },
      "step09_executeTestCase": {
        "id": "step09_executeTestCase",
        "name": "Execute Test Case",
        "type": "http",
        "dependsOn": ["step08_assertGetTest"],
        "config": {
          "method": "POST",
          "url": "{{baseUrl}}/tests/self-test-http-case/execute",
          "headers": {"Content-Type": "application/json"}
        }
      },
      "step10_assertExecution": {
        "id": "step10_assertExecution",
        "name": "Assert Test Execution",
        "type": "assert",
        "dependsOn": ["step09_executeTestCase"],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step09_executeTestCase.response.statusCode}}",
              "expected": 200,
              "message": "Execution should return 200"
            }
          ]
        }
      },
      "step11_countResults": {
        "id": "step11_countResults",
        "name": "Count Test Results in DB",
        "type": "database",
        "dependsOn": ["step10_assertExecution"],
        "config": {
          "driver": "sqlite3",
          "dsn": "{{dbPath}}",
          "queryType": "select",
          "query": "SELECT COUNT(*) as count FROM test_results WHERE test_id = ?",
          "args": ["self-test-http-case"]
        }
      },
      "step12_assertResults": {
        "id": "step12_assertResults",
        "name": "Assert Results Count",
        "type": "assert",
        "dependsOn": ["step11_countResults"],
        "config": {
          "assertions": [
            {
              "type": "greaterThan",
              "actual": "{{step11_countResults.rows[0].count}}",
              "expected": 0,
              "message": "Should have at least 1 test result"
            }
          ]
        }
      },
      "step13_deleteTestCase": {
        "id": "step13_deleteTestCase",
        "name": "Delete Test Case",
        "type": "http",
        "dependsOn": ["step12_assertResults"],
        "config": {
          "method": "DELETE",
          "url": "{{baseUrl}}/tests/self-test-http-case"
        }
      },
      "step14_verifyDeletion": {
        "id": "step14_verifyDeletion",
        "name": "Verify Test Deleted",
        "type": "database",
        "dependsOn": ["step13_deleteTestCase"],
        "config": {
          "driver": "sqlite3",
          "dsn": "{{dbPath}}",
          "queryType": "select",
          "query": "SELECT COUNT(*) as count FROM test_cases WHERE test_id = ? AND deleted_at IS NULL",
          "args": ["self-test-http-case"]
        }
      },
      "step15_assertDeletion": {
        "id": "step15_assertDeletion",
        "name": "Assert Test Deleted",
        "type": "assert",
        "dependsOn": ["step14_verifyDeletion"],
        "config": {
          "assertions": [
            {
              "type": "equals",
              "actual": "{{step13_deleteTestCase.response.statusCode}}",
              "expected": 200,
              "message": "Delete should return 200"
            },
            {
              "type": "equals",
              "actual": "{{step14_verifyDeletion.rows[0].count}}",
              "expected": 0,
              "message": "Test should be soft-deleted"
            }
          ]
        }
      },
      "step16_cleanupGroup": {
        "id": "step16_cleanupGroup",
        "name": "Cleanup Test Group",
        "type": "http",
        "dependsOn": ["step15_assertDeletion"],
        "onError": "continue",
        "config": {
          "method": "DELETE",
          "url": "{{baseUrl}}/groups/{{testGroupId}}"
        }
      }
    }
  }
}
