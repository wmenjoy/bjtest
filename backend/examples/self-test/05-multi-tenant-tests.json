{
  "name": "Multi-Tenant API Test Suite",
  "version": "1.0.0",
  "description": "Complete multi-tenant isolation and cross-tenant testing",
  "variables": {
    "baseUrl": "http://localhost:8090/api",
    "dbPath": "./data/test_management.db",
    "tenant1Id": "tenant-001",
    "tenant2Id": "tenant-002",
    "project1Id": "project-001",
    "project2Id": "project-002",
    "timestamp": ""
  },
  "steps": {
    "generateTimestamp": {
      "id": "generateTimestamp",
      "name": "Generate Unique Timestamp",
      "type": "script",
      "config": {
        "language": "python",
        "script": "import json\nimport datetime\nimport random\n\nts = datetime.datetime.now().strftime('%Y%m%d%H%M%S')\nrand_suffix = random.randint(1000, 9999)\n\nresult = {\n    'timestamp': f'{ts}{rand_suffix}',\n    'tenant1_id': f'tenant-{ts}',\n    'tenant2_id': f'tenant-other-{ts}',\n    'project1_id': f'project-{ts}',\n    'project2_id': f'project-other-{ts}',\n    'group1_id': f'group-t1-{ts}',\n    'group2_id': f'group-t2-{ts}',\n    'env1_id': f'env-t1-{ts}',\n    'env2_id': f'env-t2-{ts}'\n}\n\nprint(json.dumps(result))",
        "timeout": 5
      },
      "output": {
        "timestamp": "output.timestamp",
        "tenant1Id": "output.tenant1_id",
        "tenant2Id": "output.tenant2_id",
        "project1Id": "output.project1_id",
        "project2Id": "output.project2_id",
        "group1Id": "output.group1_id",
        "group2Id": "output.group2_id",
        "env1Id": "output.env1_id",
        "env2Id": "output.env2_id"
      }
    },

    "cleanupTestData": {
      "id": "cleanupTestData",
      "name": "Cleanup Test Data",
      "type": "database",
      "dependsOn": ["generateTimestamp"],
      "config": {
        "driver": "sqlite3",
        "dsn": "{{dbPath}}",
        "queryType": "exec",
        "query": "DELETE FROM tenants WHERE tenant_id LIKE 'tenant-%'; DELETE FROM projects WHERE project_id LIKE 'project-%'; DELETE FROM test_groups WHERE group_id LIKE 'group-t%'; DELETE FROM environments WHERE env_id LIKE 'env-t%';"
      },
      "onError": "continue"
    },

    "createTenant1": {
      "id": "createTenant1",
      "name": "[DB] Create Tenant 1",
      "type": "database",
      "dependsOn": ["cleanupTestData"],
      "config": {
        "driver": "sqlite3",
        "dsn": "{{dbPath}}",
        "queryType": "exec",
        "query": "INSERT INTO tenants (tenant_id, name, display_name, description, status, max_projects, max_users, max_test_cases) VALUES (?, 'Tenant 1', 'First Tenant', 'First tenant for testing', 'active', 10, 50, 1000)",
        "args": ["{{generateTimestamp.output.tenant1_id}}"]
      }
    },

    "createTenant2": {
      "id": "createTenant2",
      "name": "[DB] Create Tenant 2",
      "type": "database",
      "dependsOn": ["createTenant1"],
      "config": {
        "driver": "sqlite3",
        "dsn": "{{dbPath}}",
        "queryType": "exec",
        "query": "INSERT INTO tenants (tenant_id, name, display_name, description, status, max_projects, max_users, max_test_cases) VALUES (?, 'Tenant 2', 'Second Tenant', 'Second tenant for testing', 'active', 10, 50, 1000)",
        "args": ["{{generateTimestamp.output.tenant2_id}}"]
      }
    },

    "createProject1": {
      "id": "createProject1",
      "name": "[DB] Create Project 1 for Tenant 1",
      "type": "database",
      "dependsOn": ["createTenant2"],
      "config": {
        "driver": "sqlite3",
        "dsn": "{{dbPath}}",
        "queryType": "exec",
        "query": "INSERT INTO projects (project_id, tenant_id, name, display_name, description, status) VALUES (?, ?, 'Project 1', 'First Project', 'First project for tenant 1', 'active')",
        "args": ["{{generateTimestamp.output.project1_id}}", "{{generateTimestamp.output.tenant1_id}}"]
      }
    },

    "createProject2": {
      "id": "createProject2",
      "name": "[DB] Create Project 2 for Tenant 2",
      "type": "database",
      "dependsOn": ["createProject1"],
      "config": {
        "driver": "sqlite3",
        "dsn": "{{dbPath}}",
        "queryType": "exec",
        "query": "INSERT INTO projects (project_id, tenant_id, name, display_name, description, status) VALUES (?, ?, 'Project 2', 'Second Project', 'First project for tenant 2', 'active')",
        "args": ["{{generateTimestamp.output.project2_id}}", "{{generateTimestamp.output.tenant2_id}}"]
      }
    },

    "createGroupTenant1": {
      "id": "createGroupTenant1",
      "name": "[API] Create Group for Tenant 1",
      "type": "http",
      "dependsOn": ["createProject2"],
      "config": {
        "method": "POST",
        "url": "{{baseUrl}}/groups",
        "headers": {
          "Content-Type": "application/json",
          "X-Tenant-ID": "{{generateTimestamp.output.tenant1_id}}",
          "X-Project-ID": "{{generateTimestamp.output.project1_id}}"
        },
        "body": {
          "group_id": "{{generateTimestamp.output.group1_id}}",
          "name": "Tenant 1 Group",
          "description": "Test group for tenant 1"
        },
        "timeout": 5000
      }
    },

    "assertGroupTenant1Created": {
      "id": "assertGroupTenant1Created",
      "name": "[Assert] Verify Tenant 1 Group Created",
      "type": "assert",
      "dependsOn": ["createGroupTenant1"],
      "config": {
        "assertions": [
          {
            "type": "equals",
            "actual": "{{createGroupTenant1.status}}",
            "expected": 201,
            "message": "Create group should return 201"
          },
          {
            "type": "equals",
            "actual": "{{createGroupTenant1.response.group_id}}",
            "expected": "{{generateTimestamp.output.group1_id}}",
            "message": "Group ID should match"
          }
        ]
      }
    },

    "createGroupTenant2": {
      "id": "createGroupTenant2",
      "name": "[API] Create Group for Tenant 2",
      "type": "http",
      "dependsOn": ["assertGroupTenant1Created"],
      "config": {
        "method": "POST",
        "url": "{{baseUrl}}/groups",
        "headers": {
          "Content-Type": "application/json",
          "X-Tenant-ID": "{{generateTimestamp.output.tenant2_id}}",
          "X-Project-ID": "{{generateTimestamp.output.project2_id}}"
        },
        "body": {
          "group_id": "{{generateTimestamp.output.group2_id}}",
          "name": "Tenant 2 Group",
          "description": "Test group for tenant 2"
        },
        "timeout": 5000
      }
    },

    "assertGroupTenant2Created": {
      "id": "assertGroupTenant2Created",
      "name": "[Assert] Verify Tenant 2 Group Created",
      "type": "assert",
      "dependsOn": ["createGroupTenant2"],
      "config": {
        "assertions": [
          {
            "type": "equals",
            "actual": "{{createGroupTenant2.status}}",
            "expected": 201,
            "message": "Create group should return 201"
          }
        ]
      }
    },

    "verifyTenantIsolation": {
      "id": "verifyTenantIsolation",
      "name": "[DB] Verify Tenant Isolation",
      "type": "database",
      "dependsOn": ["assertGroupTenant2Created"],
      "config": {
        "driver": "sqlite3",
        "dsn": "{{dbPath}}",
        "queryType": "select",
        "query": "SELECT group_id, tenant_id, project_id FROM test_groups WHERE group_id IN (?, ?) AND deleted_at IS NULL",
        "args": ["{{generateTimestamp.output.group1_id}}", "{{generateTimestamp.output.group2_id}}"]
      }
    },

    "assertTenantIsolation": {
      "id": "assertTenantIsolation",
      "name": "[Assert] Verify Tenant Isolation in DB",
      "type": "assert",
      "dependsOn": ["verifyTenantIsolation"],
      "config": {
        "assertions": [
          {
            "type": "equals",
            "actual": "{{verifyTenantIsolation.rowCount}}",
            "expected": 2,
            "message": "Should find 2 groups (one per tenant)"
          }
        ]
      }
    },

    "tryAccessTenant2GroupFromTenant1": {
      "id": "tryAccessTenant2GroupFromTenant1",
      "name": "[API] Try Access Tenant 2 Group from Tenant 1 Context",
      "type": "http",
      "dependsOn": ["assertTenantIsolation"],
      "config": {
        "method": "GET",
        "url": "{{baseUrl}}/groups/{{generateTimestamp.output.group2_id}}",
        "headers": {
          "Content-Type": "application/json",
          "X-Tenant-ID": "{{generateTimestamp.output.tenant1_id}}",
          "X-Project-ID": "{{generateTimestamp.output.project1_id}}"
        },
        "timeout": 5000
      }
    },

    "assertCross–¢enantAccessDenied": {
      "id": "assertCrossTenantAccessDenied",
      "name": "[Assert] Verify Cross-Tenant Access Denied",
      "type": "assert",
      "dependsOn": ["tryAccessTenant2GroupFromTenant1"],
      "config": {
        "assertions": [
          {
            "type": "equals",
            "actual": "{{tryAccessTenant2GroupFromTenant1.status}}",
            "expected": 404,
            "message": "Cross-tenant access should return 404"
          }
        ]
      }
    },

    "createEnvTenant1": {
      "id": "createEnvTenant1",
      "name": "[API] Create Environment for Tenant 1",
      "type": "http",
      "dependsOn": ["assertCrossTenantAccessDenied"],
      "config": {
        "method": "POST",
        "url": "{{baseUrl}}/environments",
        "headers": {
          "Content-Type": "application/json",
          "X-Tenant-ID": "{{generateTimestamp.output.tenant1_id}}",
          "X-Project-ID": "{{generateTimestamp.output.project1_id}}"
        },
        "body": {
          "env_id": "{{generateTimestamp.output.env1_id}}",
          "name": "Tenant 1 Dev Environment",
          "description": "Dev environment for tenant 1",
          "is_active": true,
          "variables": {
            "API_URL": "http://tenant1.example.com",
            "API_KEY": "tenant1-key-123"
          }
        },
        "timeout": 5000
      }
    },

    "assertEnvTenant1Created": {
      "id": "assertEnvTenant1Created",
      "name": "[Assert] Verify Tenant 1 Environment Created",
      "type": "assert",
      "dependsOn": ["createEnvTenant1"],
      "config": {
        "assertions": [
          {
            "type": "equals",
            "actual": "{{createEnvTenant1.status}}",
            "expected": 201,
            "message": "Create environment should return 201"
          }
        ]
      }
    },

    "createEnvTenant2": {
      "id": "createEnvTenant2",
      "name": "[API] Create Environment for Tenant 2",
      "type": "http",
      "dependsOn": ["assertEnvTenant1Created"],
      "config": {
        "method": "POST",
        "url": "{{baseUrl}}/environments",
        "headers": {
          "Content-Type": "application/json",
          "X-Tenant-ID": "{{generateTimestamp.output.tenant2_id}}",
          "X-Project-ID": "{{generateTimestamp.output.project2_id}}"
        },
        "body": {
          "env_id": "{{generateTimestamp.output.env2_id}}",
          "name": "Tenant 2 Dev Environment",
          "description": "Dev environment for tenant 2",
          "is_active": true,
          "variables": {
            "API_URL": "http://tenant2.example.com",
            "API_KEY": "tenant2-key-456"
          }
        },
        "timeout": 5000
      }
    },

    "getActiveEnvTenant1": {
      "id": "getActiveEnvTenant1",
      "name": "[API] Get Active Environment for Tenant 1",
      "type": "http",
      "dependsOn": ["createEnvTenant2"],
      "config": {
        "method": "GET",
        "url": "{{baseUrl}}/environments/active",
        "headers": {
          "Content-Type": "application/json",
          "X-Tenant-ID": "{{generateTimestamp.output.tenant1_id}}",
          "X-Project-ID": "{{generateTimestamp.output.project1_id}}"
        },
        "timeout": 5000
      }
    },

    "assertActiveEnvTenant1": {
      "id": "assertActiveEnvTenant1",
      "name": "[Assert] Verify Tenant 1 Active Environment",
      "type": "assert",
      "dependsOn": ["getActiveEnvTenant1"],
      "config": {
        "assertions": [
          {
            "type": "equals",
            "actual": "{{getActiveEnvTenant1.status}}",
            "expected": 200,
            "message": "Get active environment should return 200"
          },
          {
            "type": "equals",
            "actual": "{{getActiveEnvTenant1.response.env_id}}",
            "expected": "{{generateTimestamp.output.env1_id}}",
            "message": "Tenant 1 should get its own environment"
          },
          {
            "type": "equals",
            "actual": "{{getActiveEnvTenant1.response.variables.API_KEY}}",
            "expected": "tenant1-key-123",
            "message": "Should get tenant 1 API key"
          }
        ]
      }
    },

    "getActiveEnvTenant2": {
      "id": "getActiveEnvTenant2",
      "name": "[API] Get Active Environment for Tenant 2",
      "type": "http",
      "dependsOn": ["assertActiveEnvTenant1"],
      "config": {
        "method": "GET",
        "url": "{{baseUrl}}/environments/active",
        "headers": {
          "Content-Type": "application/json",
          "X-Tenant-ID": "{{generateTimestamp.output.tenant2_id}}",
          "X-Project-ID": "{{generateTimestamp.output.project2_id}}"
        },
        "timeout": 5000
      }
    },

    "assertActiveEnvTenant2": {
      "id": "assertActiveEnvTenant2",
      "name": "[Assert] Verify Tenant 2 Active Environment",
      "type": "assert",
      "dependsOn": ["getActiveEnvTenant2"],
      "config": {
        "assertions": [
          {
            "type": "equals",
            "actual": "{{getActiveEnvTenant2.status}}",
            "expected": 200,
            "message": "Get active environment should return 200"
          },
          {
            "type": "equals",
            "actual": "{{getActiveEnvTenant2.response.env_id}}",
            "expected": "{{generateTimestamp.output.env2_id}}",
            "message": "Tenant 2 should get its own environment"
          },
          {
            "type": "equals",
            "actual": "{{getActiveEnvTenant2.response.variables.API_KEY}}",
            "expected": "tenant2-key-456",
            "message": "Should get tenant 2 API key"
          }
        ]
      }
    },

    "verifyEnvironmentIsolationInDB": {
      "id": "verifyEnvironmentIsolationInDB",
      "name": "[DB] Verify Environment Isolation",
      "type": "database",
      "dependsOn": ["assertActiveEnvTenant2"],
      "config": {
        "driver": "sqlite3",
        "dsn": "{{dbPath}}",
        "queryType": "select",
        "query": "SELECT env_id, tenant_id, project_id, name FROM environments WHERE env_id IN (?, ?) AND deleted_at IS NULL",
        "args": ["{{generateTimestamp.output.env1_id}}", "{{generateTimestamp.output.env2_id}}"]
      }
    },

    "assertEnvIsolationInDB": {
      "id": "assertEnvIsolationInDB",
      "name": "[Assert] Verify Environment Isolation in DB",
      "type": "assert",
      "dependsOn": ["verifyEnvironmentIsolationInDB"],
      "config": {
        "assertions": [
          {
            "type": "equals",
            "actual": "{{verifyEnvironmentIsolationInDB.rowCount}}",
            "expected": 2,
            "message": "Should find 2 environments (one per tenant)"
          }
        ]
      }
    },

    "cleanupTestDataFinal": {
      "id": "cleanupTestDataFinal",
      "name": "[Cleanup] Remove Test Data",
      "type": "database",
      "dependsOn": ["assertEnvIsolationInDB"],
      "config": {
        "driver": "sqlite3",
        "dsn": "{{dbPath}}",
        "queryType": "exec",
        "query": "DELETE FROM environments WHERE env_id IN (?, ?); DELETE FROM test_groups WHERE group_id IN (?, ?); DELETE FROM projects WHERE project_id IN (?, ?); DELETE FROM tenants WHERE tenant_id IN (?, ?);",
        "args": [
          "{{generateTimestamp.output.env1_id}}",
          "{{generateTimestamp.output.env2_id}}",
          "{{generateTimestamp.output.group1_id}}",
          "{{generateTimestamp.output.group2_id}}",
          "{{generateTimestamp.output.project1_id}}",
          "{{generateTimestamp.output.project2_id}}",
          "{{generateTimestamp.output.tenant1_id}}",
          "{{generateTimestamp.output.tenant2_id}}"
        ]
      }
    },

    "generateTestSummary": {
      "id": "generateTestSummary",
      "name": "[Summary] Generate Multi-Tenant Test Report",
      "type": "script",
      "dependsOn": ["cleanupTestDataFinal"],
      "config": {
        "language": "python",
        "script": "import json\nimport datetime\n\nresult = {\n    'test_suite': 'Multi-Tenant API Complete Test',\n    'completed_at': datetime.datetime.now().isoformat(),\n    'tests_executed': [\n        'Create Tenants',\n        'Create Projects',\n        'Create Groups with Tenant Context',\n        'Verify Tenant Isolation',\n        'Test Cross-Tenant Access Denial',\n        'Create Environments with Tenant Context',\n        'Verify Environment Isolation',\n        'Verify Active Environment per Tenant'\n    ],\n    'total_tests': 8,\n    'tenants_tested': 2,\n    'isolation_verified': True,\n    'cross_tenant_access_blocked': True,\n    'all_passed': True\n}\n\nprint(json.dumps(result, indent=2))",
        "timeout": 5
      }
    }
  }
}
