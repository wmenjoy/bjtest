# 1.2.4 设计示意图 - 测试执行器

## 功能描述

测试用例的执行界面，支持手动步骤执行、HTTP API 自动化执行、工作流执行。提供实时执行日志、AI Copilot 辅助、变量替换、环境选择等功能。

## 页面结构

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║  执行测试用例: TC-001 用户登录测试                               [AI助手] [X] ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║  进度: [████████████░░░░░░░░░░░] 60% (3/5 步骤完成)                          ║
║                                                                               ║
║  ┌─────────────────────────────────────────┬───────────────────────────────┐ ║
║  │  步骤列表                                │  执行日志                     │ ║
║  │                                         │                               │ ║
║  │  ✓ 1. 打开登录页面                      │  [09:30:15] 开始执行...       │ ║
║  │      GET /login                         │  [09:30:16] 步骤 1 执行成功   │ ║
║  │      Status: PASSED                     │  [09:30:17] 响应时间: 120ms   │ ║
║  │                                         │  [09:30:18] 步骤 2 执行中...  │ ║
║  │  ✓ 2. 输入用户名                        │  [09:30:19] 发送 POST 请求    │ ║
║  │      POST /api/auth/login               │  [09:30:20] 响应状态: 200     │ ║
║  │      Status: PASSED                     │  [09:30:21] Token 已保存      │ ║
║  │                                         │                               │ ║
║  │  → 3. 输入密码 [执行中]                 │  ...更多日志...               │ ║
║  │      Expected: 密码框显示               │                               │ ║
║  │      Status: RUNNING                    │                               │ ║
║  │                                         │                               │ ║
║  │  ○ 4. 点击登录按钮                      │                               │ ║
║  │      Status: PENDING                    │                               │ ║
║  │                                         │                               │ ║
║  │  ○ 5. 验证登录成功                      │                               │ ║
║  │      Status: PENDING                    │                               │ ║
║  └─────────────────────────────────────────┴───────────────────────────────┘ ║
║                                                                               ║
║  笔记: [_______________________________________________________________]      ║
║                                                                               ║
║  [自动执行] [下一步] [跳过] [停止] [AI分析错误]                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝

### 子功能: AI Copilot 面板

       ╔═══════════════════════════════════════╗
       ║  AI 执行助手                    [×]   ║
       ╠═══════════════════════════════════════╣
       ║                                       ║
       ║  🤖 AI: 我正在监控你的测试执行。      ║
       ║      如果遇到错误，我可以帮你分析。   ║
       ║                                       ║
       ║  👤 你: 分析当前的错误日志             ║
       ║                                       ║
       ║  🤖 AI: 根据日志分析，登录失败是因为  ║
       ║      密码加密方式不匹配...            ║
       ║                                       ║
       ║  [输入消息_________________] [发送]   ║
       ╚═══════════════════════════════════════╝
```

## 交互流程

- 测试开始 → 加载测试用例和环境配置
- 手动模式 → 点击"下一步"逐步执行
- 自动模式 → 点击"自动执行"一次性执行所有步骤
- 步骤执行 → 替换变量 → 调用 API/执行命令 → 记录结果
- 执行完成 → 收集结果 → 保存到测试历史 → 返回 [1.2.3 测试用例管理]
- 遇到错误 → 点击"AI分析错误" → 打开 AI Copilot → 获取建议
- 点击"跳过" → 标记当前步骤为 SKIPPED
- 点击"停止" → 提示确认 → 中断执行

## 数据字段

| 字段名 | 类型 | 校验规则 | 说明 |
|--------|------|----------|------|
| testCase | object | 必填 | 被执行的测试用例 |
| mode | enum | STEPS/WORKFLOW | 执行模式 |
| currentStepIndex | number | 0 到 steps.length-1 | 当前执行步骤索引 |
| stepStatuses | object | 步骤ID: 状态 | 每个步骤的执行状态 |
| executionLog | array | - | 执行日志数组 |
| notes | string | 最多1000字符 | 执行备注 |
| progress | number | 0-100 | 执行进度百分比 |
| activeEnvironment | object | - | 当前选择的环境配置 |

## 权限说明

- 访问权限：已登录用户
- 权限要求：EXECUTE_TESTS 权限
- 数据范围：可执行当前项目的测试用例
- 环境变量：根据权限显示敏感变量（脱敏显示）

## 后端 API 依赖

- `POST /api/tests/execute` - 执行测试步骤（HTTP 类型）
- `POST /api/workflows/execute` - 执行工作流（Workflow 类型）
- `POST /api/runs` - 保存测试执行记录
- `POST /api/gemini/analyze` - AI 分析错误日志（前端调用）
- `WS /api/workflows/stream` - WebSocket 实时日志流（工作流模式）

## 实现建议

- 使用状态机管理执行流程（IDLE → RUNNING → COMPLETED/FAILED）
- 变量替换使用正则表达式 `{{VAR_NAME}}`
- 敏感变量（isSecret=true）在日志中自动脱敏显示为 `********`
- 执行日志使用虚拟滚动优化性能
- AI Copilot 使用侧边抽屉或悬浮窗口
- 支持快捷键操作（Space: 下一步，Esc: 停止）
- 实时更新进度条和步骤状态
- 工作流模式使用 WebSocket 接收实时日志

## 测试要点

- [ ] 手动执行模式逐步执行正确
- [ ] 自动执行模式连续执行所有步骤
- [ ] 变量替换功能正常工作
- [ ] 环境变量正确注入
- [ ] 敏感变量脱敏显示
- [ ] 执行日志实时更新
- [ ] 进度条准确显示
- [ ] 步骤状态图标正确（✓/✗/○/→）
- [ ] AI Copilot 对话功能正常
- [ ] 错误分析给出有效建议
- [ ] 跳过步骤功能正常
- [ ] 停止执行立即中断
- [ ] 执行结果正确保存到历史记录
- [ ] WebSocket 连接稳定（工作流模式）

### 子功能 1: AI Copilot 聊天面板

```
       ╔═══════════════════════════════════════╗
       ║  AI 执行助手                    [×]   ║
       ╠═══════════════════════════════════════╣
       ║                                       ║
       ║  🤖 AI: 我正在监控你的测试执行。      ║
       ║      如果遇到错误，我可以帮你分析。   ║
       ║                                       ║
       ║  👤 你: 分析当前的错误日志             ║
       ║                                       ║
       ║  🤖 AI: 根据日志分析，登录失败是因为  ║
       ║      密码加密方式不匹配。建议检查：   ║
       ║      1. 前端加密算法配置              ║
       ║      2. 后端解密逻辑                  ║
       ║      3. 环境变量中的加密密钥          ║
       ║                                       ║
       ║  👤 你: 如何修复这个问题？            ║
       ║                                       ║
       ║  [输入消息_________________] [发送]   ║
       ╚═══════════════════════════════════════╝
```

**说明**: AI 助手实时分析执行日志，提供错误诊断和修复建议。使用 Gemini API 进行智能分析。

### 子功能 2: 执行结果详情页

测试执行完成后显示的详细结果页面：

```
╔═══════════════════════════════════════════════════════════╗
║  执行结果: RUN-12345                          [导出]  [X]║
╠═══════════════════════════════════════════════════════════╣
║                                                           ║
║  测试用例: TC-001 用户登录测试                            ║
║  执行时间: 2024-11-22 15:30:25                            ║
║  执行状态: ✓ PASSED                                       ║
║  总耗时: 3.5 秒                                           ║
║                                                           ║
║  步骤执行详情:                                            ║
║  ┌───────────────────────────────────────────────────┐   ║
║  │ ✓ 步骤 1: 访问登录页面                    0.8s  │   ║
║  │   请求: GET /login                               │   ║
║  │   响应: 200 OK                                   │   ║
║  │   断言: 页面标题 = "登录" ✓                      │   ║
║  │                                                   │   ║
║  │ ✓ 步骤 2: 提交登录请求                    1.2s  │   ║
║  │   请求: POST /api/auth/login                     │   ║
║  │   Body: {"username":"admin","password":"***"}    │   ║
║  │   响应: 200 OK                                   │   ║
║  │   断言: response.token 存在 ✓                    │   ║
║  │                                                   │   ║
║  │ ✓ 步骤 3: 验证登录状态                    1.5s  │   ║
║  │   请求: GET /api/user/me                         │   ║
║  │   Headers: Authorization: Bearer ***             │   ║
║  │   响应: 200 OK                                   │   ║
║  │   断言: response.username = "admin" ✓            │   ║
║  └───────────────────────────────────────────────────┘   ║
║                                                           ║
║  环境变量:                                                ║
║  - API_BASE: http://localhost:8090                        ║
║  - USERNAME: admin                                        ║
║  - PASSWORD: ******                                       ║
║                                                           ║
║  [重新运行]  [复制日志]  [关闭]                           ║
╚═══════════════════════════════════════════════════════════╝
```

**说明**: 展示详细的执行步骤、请求/响应数据、断言结果和环境变量。支持导出和重新运行。

### 子功能 3: 工作流可视化视图

当执行工作流类型的测试时，显示可视化流程图：

```
╔═══════════════════════════════════════════════════════════╗
║  工作流执行: 用户认证流程                      [实时日志]║
╠═══════════════════════════════════════════════════════════╣
║                                                           ║
║          ┌───────────┐                                    ║
║          │  开始     │                                    ║
║          └─────┬─────┘                                    ║
║                │                                          ║
║          ┌─────▼─────┐                                    ║
║          │ Step 1    │ ✓ 完成 (1.2s)                     ║
║          │ 用户登录  │                                    ║
║          └─────┬─────┘                                    ║
║                │                                          ║
║          ┌─────▼─────┐                                    ║
║          │ Step 2    │ → 执行中...                       ║
║          │ 获取权限  │                                    ║
║          └─────┬─────┘                                    ║
║                │                                          ║
║     ┌──────────┴──────────┐                              ║
║     │                     │                              ║
║ ┌───▼────┐           ┌───▼────┐                         ║
║ │ Step 3a│ ○ 等待    │ Step 3b│ ○ 等待                  ║
║ │ 读数据 │           │ 写数据 │                          ║
║ └───┬────┘           └───┬────┘                          ║
║     │                     │                              ║
║     └──────────┬──────────┘                              ║
║                │                                          ║
║          ┌─────▼─────┐                                    ║
║          │ Step 4    │ ○ 等待                            ║
║          │ 验证结果  │                                    ║
║          └─────┬─────┘                                    ║
║                │                                          ║
║          ┌─────▼─────┐                                    ║
║          │  结束     │                                    ║
║          └───────────┘                                    ║
║                                                           ║
║  图例: ✓ 成功 | ✗ 失败 | → 执行中 | ○ 等待               ║
╚═══════════════════════════════════════════════════════════╝
```

**说明**: 实时显示工作流执行进度，使用 DAG 图展示步骤依赖关系和执行状态。

---

*此线框图由 ui-wireframe-generator skill 自动生成*
